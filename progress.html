<!DOCTYPE html>

<!-- formatting rev 3 -->

<html lang="en">
<head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VV4YLNW79F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VV4YLNW79F');
</script>
  
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Rising Progress</title>

<!-- Chart.js + Annotation plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  if (window['chartjs-plugin-annotation'] && window.Chart) {
    Chart.register(window['chartjs-plugin-annotation']);
  }
</script>

<link rel="stylesheet" href="css/progress.css">
  <link rel="icon" href="risingprogress.ico" type="image/x-icon"/>

<style>
#toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: #2563eb; /* Rising Progress blue */
  color: #ffffff;
  padding: 10px 18px;
  border-radius: 999px;
  font-size: 14px;
  border: 2px solid #ea580c; /* Rising Progress orange */
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
  z-index: 9999;
}
#toast.show {
  opacity: 1;
}
</style>

</head>
<body>




  
<div class="wrap">
<datalist id="unitsList">
<option value="%"></option>
<option value="Feet"></option>
<option value="Inches"></option>
<option value="Qty"></option>
<option value="Yd^3"></option>
<option value="Meters"></option>
<option value="Centimeters"></option>
</datalist>
<!-- Big Chart Card -->
<div class="card" style="margin-top:16px">
<div class="chart-header">
<div class="left input-inline">
<label for="projectName">Project Name:</label>
<input id="projectName" placeholder="e.g. West Pipeline"/>


  
</div>
<div class="right input-inline" style="margin-left:auto; gap:6px">
  <button id="authButton">Logout</button>


  
</div>
</div>
<div style="position: relative; padding-bottom: 0;"><canvas id="progressChart"></canvas><img src="risingprogress.png" style="position: absolute; right: 20px; bottom: 85px; height: 50px; width: auto; z-index: 10; pointer-events: none;"/></div>
<div class="custom-legend" id="customLegend"></div>
<div class="small" id="bpStats" style="margin-top:6px; display:flex; gap:16px;"></div>
<div class="pill" id="planDelta" style="margin-top:8px"></div>

  <!-- Move startup controls here -->
<div class="right input-inline" style="margin-left:0; margin-top:10px; gap:6px">
<input type="checkbox" id="labelToggle" checked style="accent-color:grey; width:16px; height:16px; margin-right:-35px; vertical-align:middle;margin-top:30px;"><label for="startupLabelInput">Label:</label>
<input class="inline-skinny" id="startupLabelInput" value="Baseline Complete"/>
<input id="projectStartup" type="date"/>

  
</div>
<!-- Scopes -->
<div class="card" style="margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center">
<h2>Scopes</h2>
</div>
<div class="toolbar" style="margin:8px 0 4px 0">

<button id="toolbarSave">ðŸ’¾ Save Project</button>
<div id="saveDropdown" style="display:none; position:absolute; background:white; border:1px solid #ccc; z-index:1000;">
  <div id="saveCSV" style="padding:8px; cursor:pointer;">Save as CSV</div>
  <div id="saveXML" style="padding:8px; cursor:pointer;">Save as XML</div>
</div>

<div style="position:relative;"><button id="toolbarLoad">ðŸ“‚ Load Project â–¾</button><div id="loadDropdown" style="display:none; position:absolute; background:white; border:1px solid #ccc; z-index:1000;"><div data-act="open" style="padding:8px; cursor:pointer;">Open File</div><div data-act="default" style="padding:8px; cursor:pointer;">Default</div><div data-act="pipeline" style="padding:8px; cursor:pointer;">Pipeline</div><div data-act="mech" style="padding:8px; cursor:pointer;">Mech Facility</div><div data-act="ie" style="padding:8px; cursor:pointer;">I&E Facility</div></div></div>
<button id="toolbarClear">ðŸ”„ Clear</button>
</div>
<div class="row head" style="margin-top:8px">
<div>Scope</div>
<div>Start</div>
<div>End</div>
<div>Cost ($) or<br/>% Weight</div>
<div>Total Units<br/>(if Units)</div>
<div>% or Units<br/>to Date</div>
<div>Units</div>
<div class="small" data-k="plannedLabel">Planned % or<br/>Units to Date</div>
<div class="center">Row<br/>Actions</div>
</div>
<div id="scopeRows"></div>
</div>
<!-- Controls BELOW Scope Tracking -->
<div class="card" style="margin-top:16px">
<div class="toolbar" id="summaryBar">
<button class="btn-primary" id="snapshot">ðŸ“ˆ Add to History</button>
<span class="pill">Current Progress: <strong id="totalActual">0.00%</strong> <input id="historyDate" style="margin-left:6px" type="date"/></span>
</div>
</div>
<!-- History + Baseline -->
<div class="stack-when-narrow" style="margin-top:16px">
<div class="card narrow">
<div style="display:flex;align-items:center;gap:8px">
<h2>History</h2>
<button id="baselineBtn">ðŸ§± Set Original (Baseline) Plan</button>
</div>
<table id="dailyTable" style="margin-top:8px;width:auto">
<thead>
<tr>
<th>Date</th>
<th class="right">Original %</th>
<th class="right">Planned %</th>
<th class="right">Actual %</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>


  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import "./js/progress.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDai5gpX1x9I3uaF4MI7WAzq2oItLRPoZA",
    authDomain: "rising-progress.firebaseapp.com",
    projectId: "rising-progress",
    storageBucket: "rising-progress.firebasestorage.app",
    messagingSenderId: "823687590636",
    appId: "1:823687590636:web:77c65293b277b2a489abc9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  function showToast(msg) {
    const t = document.getElementById("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.add("show");
    if (window._toastTimer) {
      clearTimeout(window._toastTimer);
    }
    window._toastTimer = setTimeout(() => {
      t.classList.remove("show");
    }, 1800);
  }


  function redirectToLogin() {
    try {
      // Persist current model into cookie before redirect, if available
      if (window.model && typeof window.setCookie === "function" && window.COOKIE_KEY) {
        window.setCookie(window.COOKIE_KEY, JSON.stringify(window.model), 3650);
      }
    } catch (e) {
      console.error("Failed to persist model before login redirect", e);
    }
    const url = new URL(window.location.href);
    url.pathname = url.pathname.replace(/[^\/]*$/, "login.html");
    url.searchParams.set("redirect", "progress.html");
    window.location.href = url.toString();
  }

  // Auth-gated save wrappers used by progress.js
  window.requireAuthForSaveAll = function () {
    const user = auth.currentUser;
    if (!user) {
      try {
        sessionStorage.setItem("pendingSave", "csv");
      } catch (e) {
        console.error("Unable to set pendingSave in sessionStorage", e);
      }
      redirectToLogin();
      return;
    }
    if (typeof window.saveAll === "function") {
      window.saveAll();
    } else if (typeof window.saveCsv === "function") {
      window.saveCsv();
    }
  };

  window.requireAuthForSaveXml = function () {
    const user = auth.currentUser;
    if (!user) {
      try {
        sessionStorage.setItem("pendingSave", "xml");
      } catch (e) {
        console.error("Unable to set pendingSave in sessionStorage", e);
      }
      redirectToLogin();
      return;
    }
    if (typeof window.saveXml === "function") {
      window.saveXml();
    }
  };

  document.addEventListener("DOMContentLoaded", () => {
    const authButton = document.getElementById("authButton");
    const saveButton = document.getElementById("toolbarSave");

    function updateUi(user) {
      if (!authButton || !saveButton) return;
      if (user) {
        authButton.textContent = "Logout";
        authButton.onclick = () => {
          signOut(auth).catch(err => console.error("Logout failed", err));
        };
        saveButton.textContent = "ðŸ’¾ Save Project";
        saveButton.title = "Save project to CSV or XML";
      } else {
        authButton.textContent = "Login";
        authButton.onclick = () => redirectToLogin();
        saveButton.textContent = "ðŸ”’ Save Project";
        saveButton.title = "Login to enable saving CSV/XML";
      }
    }

    onAuthStateChanged(auth, (user) => {
      window.currentUserForSave = user;
      updateUi(user);

      if (user) {
        let pending = null;
        try {
          pending = sessionStorage.getItem("pendingSave");
        } catch (e) {
          console.error("Unable to read pendingSave from sessionStorage", e);
        }

        window._autoSaving = true;
        if (pending) {
          if (typeof showToast === "function") {
            
          }
          setTimeout(() => {
            try {
              if (pending === "csv" && typeof window.saveAll === "function") {
                window.saveAll();
              } else if (pending === "xml" && typeof window.saveXml === "function") {
                window.saveXml();
              }
            } finally {
              try {
                sessionStorage.removeItem("pendingSave"); window._autoSaving=false;
              } catch (e) {
                console.error("Unable to clear pendingSave from sessionStorage", e);
              }
            }
          }, 500);
        }
      }
    });
  });
</script>

  <div id="toast"></div>

</body>
</html>

